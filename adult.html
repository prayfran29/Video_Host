<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Magnus Video Streams - Adult</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <header class="header">
        <div class="container">
            <div class="nav-brand">
                <h1>Magnus Video Streams - Adult</h1>
            </div>
            <div class="nav-actions">
                <button class="profile-btn" onclick="goHome()">üè† Home</button>
                <button class="profile-btn" onclick="logout()" id="profileButton">üë§ Logout</button>
            </div>
        </div>
    </header>

    <main>
        <section class="content-sections" style="margin-top: 80px;">
            <div class="container">
                <div class="section">
                    <h3>Continue Watching</h3>
                    <div class="continue-watching-swimlane" id="continueWatchingGrid">
                        <!-- Continue watching items will be populated here -->
                    </div>
                </div>

                <div id="genreSections">
                    <!-- Genre swimlanes will be populated here -->
                </div>
                
                <div class="section">
                    <h3>All Series</h3>
                    <div class="content-grid" id="allSeriesGrid">
                        <!-- All videos will be populated here -->
                    </div>
                </div>
            </div>
        </section>
    </main>

    <!-- Series Modal -->
    <div id="seriesModal" class="modal">
        <div class="modal-content series-modal">
            <span class="close" onclick="closeSeries()">&times;</span>
            <h3 id="seriesTitle"></h3>
            <div id="videoList" class="video-list">
                <!-- Video episodes will be populated here -->
            </div>
        </div>
    </div>

    <!-- Video Player Modal -->
    <div id="videoModal" class="modal">
        <div class="modal-content video-modal">
            <span class="close" onclick="closeVideo()">&times;</span>
            <div class="video-container">
                <video id="videoPlayer" controls preload="metadata" autoplay>
                    <source src="" type="video/mp4">
                    Your browser does not support the video tag.
                </video>
                <div id="videoLoading" class="video-loading" style="display:none;">
                    <div class="loading-spinner"></div>
                    <p>Loading video...</p>
                </div>
            </div>
            <div class="audio-controls">
                <label>Audio Track:</label>
                <select id="audioTrackSelect" onchange="switchAudioTrack()"></select>
            </div>
            <div class="video-controls">
                <button id="prevBtn" onclick="playPreviousVideo()" style="display:none">‚èÆ Previous</button>
                <button id="nextBtn" onclick="playNextVideo()" style="display:none">Next ‚è≠</button>
            </div>
            <div class="video-info">
                <h3 id="videoTitle"></h3>
                <p id="videoDetails"></p>
            </div>
        </div>
    </div>

    <script>
        let currentUser = null;
        let authToken = localStorage.getItem('authToken');
        let currentSeries = null;
        let currentVideoIndex = 0;

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            if (authToken) {
                currentUser = JSON.parse(localStorage.getItem('currentUser'));
                if (currentUser) {
                    loadAdultSeries();
                } else {
                    window.location.href = '/';
                }
            } else {
                window.location.href = '/';
            }
        });

        async function loadAdultSeries() {
            try {
                const response = await fetch('/api/series/adult', {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });
                const series = await response.json();
                renderSeries(series);
            } catch (error) {
                console.error('Failed to load adult series');
            }
        }

        function renderSeries(series) {
            const allSeriesGrid = document.getElementById('allSeriesGrid');
            allSeriesGrid.innerHTML = '';
            series.forEach(s => {
                const card = createSeriesCard(s);
                allSeriesGrid.appendChild(card);
            });
        }

        function createSeriesCard(series, showProgress = false) {
            const card = document.createElement('div');
            card.className = 'content-card';
            card.onclick = () => openSeries(series);
            
            let progressText = `${series.videoCount} videos`;
            if (showProgress && watchProgress[series.id]) {
                const completed = Object.values(watchProgress[series.id]).filter(v => v.completed).length;
                progressText = `${completed}/${series.videoCount} completed`;
            }
            
            const genreText = series.genre && series.genre !== 'Root' ? `${series.genre} ‚Ä¢ ` : '';
            
            card.innerHTML = `
                <div class="card-image" style="background-image: url('${series.thumbnail || ''}')"></div>
                <div class="card-info">
                    <h4>${series.title}</h4>
                    <p>${genreText}${progressText}</p>
                </div>
            `;
            return card;
        }

        async function openSeries(series) {
            try {
                const response = await fetch(`/api/series/${series.id}`, {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });
                currentSeries = await response.json();
                showSeriesModal(currentSeries);
            } catch (error) {
                console.error('Failed to load series');
            }
        }

        function showSeriesModal(series) {
            const modal = document.getElementById('seriesModal');
            const title = document.getElementById('seriesTitle');
            const videoList = document.getElementById('videoList');
            
            title.textContent = series.title;
            videoList.innerHTML = '';
            
            series.videos.forEach((video, index) => {
                const item = document.createElement('div');
                item.className = 'video-item';
                item.innerHTML = `
                    <span>${video.title}</span>
                    <button onclick="playVideo('${video.url}', '${video.filename}', '${video.title}', ${index})">‚ñ∂ Play</button>
                `;
                videoList.appendChild(item);
            });
            
            modal.style.display = 'block';
        }

        function playVideo(url, filename, title, videoIndex = null) {
            const modal = document.getElementById('videoModal');
            const player = document.getElementById('videoPlayer');
            const videoTitle = document.getElementById('videoTitle');
            const details = document.getElementById('videoDetails');
            
            if (videoIndex !== null) {
                currentVideoIndex = videoIndex;
            }
            
            player.src = '';
            document.getElementById('videoLoading').style.display = 'block';
            
            videoTitle.textContent = title;
            details.textContent = currentSeries ? currentSeries.title : '';
            
            player.preload = 'metadata';
            
            let retryCount = 0;
            player.onerror = () => {
                if (retryCount < 3) {
                    retryCount++;
                    setTimeout(() => {
                        player.load();
                    }, 1000 * retryCount);
                }
            };
            
            player.onloadstart = () => {
                document.getElementById('videoLoading').style.display = 'block';
            };
            
            player.oncanplay = () => {
                document.getElementById('videoLoading').style.display = 'none';
            };
            
            player.onwaiting = () => {
                document.getElementById('videoLoading').style.display = 'block';
            };
            
            player.onplaying = () => {
                document.getElementById('videoLoading').style.display = 'none';
            };
            
            player.onloadedmetadata = () => {
                setupAudioTracks();
                if (player.audioTracks && player.audioTracks.length >= 2) {
                    player.audioTracks[1].enabled = true;
                    player.audioTracks[0].enabled = false;
                }
                player.volume = 1.0;
                player.muted = false;
                
                if (currentUser && currentSeries && watchProgress[currentSeries.id] && watchProgress[currentSeries.id][filename]) {
                    const progress = watchProgress[currentSeries.id][filename];
                    player.currentTime = progress.currentTime || 0;
                }
                
                player.play().catch(() => {});
            };
            
            player.src = url;
            
            updateVideoControls();
            
            if (currentUser && currentSeries) {
                player.ontimeupdate = () => saveProgress(filename, player.currentTime, player.duration);
                player.onended = () => {
                    saveProgress(filename, player.duration, player.duration, true);
                    playNextVideo();
                };
            } else {
                player.onended = () => playNextVideo();
            }
            
            modal.style.display = 'block';
            document.getElementById('seriesModal').style.display = 'none';
        }

        async function saveProgress(filename, currentTime, duration, completed = false) {
            if (!authToken || !currentSeries) return;
            
            try {
                await fetch('/api/progress', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${authToken}`
                    },
                    body: JSON.stringify({
                        seriesId: currentSeries.id,
                        videoFile: filename,
                        currentTime,
                        duration,
                        completed
                    })
                });
                
                if (!watchProgress[currentSeries.id]) watchProgress[currentSeries.id] = {};
                watchProgress[currentSeries.id][filename] = { currentTime, duration, completed };
            } catch (error) {
                // Silent fail
            }
        }

        function updateVideoControls() {
            const prevBtn = document.getElementById('prevBtn');
            const nextBtn = document.getElementById('nextBtn');
            
            if (currentSeries && currentSeries.videos) {
                prevBtn.style.display = currentVideoIndex > 0 ? 'inline-block' : 'none';
                nextBtn.style.display = currentVideoIndex < currentSeries.videos.length - 1 ? 'inline-block' : 'none';
            }
        }

        function playPreviousVideo() {
            if (currentSeries && currentVideoIndex > 0) {
                const prevVideo = currentSeries.videos[currentVideoIndex - 1];
                playVideo(prevVideo.url, prevVideo.filename, prevVideo.title, currentVideoIndex - 1);
            }
        }

        function playNextVideo() {
            if (currentSeries && currentVideoIndex < currentSeries.videos.length - 1) {
                const nextVideo = currentSeries.videos[currentVideoIndex + 1];
                playVideo(nextVideo.url, nextVideo.filename, nextVideo.title, currentVideoIndex + 1);
            }
        }

        function setupAudioTracks() {
            const player = document.getElementById('videoPlayer');
            const select = document.getElementById('audioTrackSelect');
            
            select.innerHTML = '';
            
            if (player.audioTracks && player.audioTracks.length > 0) {
                for (let i = 0; i < player.audioTracks.length; i++) {
                    const track = player.audioTracks[i];
                    const option = document.createElement('option');
                    option.value = i;
                    option.textContent = track.label || `Track ${i + 1}`;
                    if (track.enabled) option.selected = true;
                    select.appendChild(option);
                }
                document.querySelector('.audio-controls').style.display = 'block';
            } else {
                document.querySelector('.audio-controls').style.display = 'none';
            }
        }

        function switchAudioTrack() {
            const player = document.getElementById('videoPlayer');
            const select = document.getElementById('audioTrackSelect');
            const selectedIndex = parseInt(select.value);
            
            if (player.audioTracks) {
                for (let i = 0; i < player.audioTracks.length; i++) {
                    player.audioTracks[i].enabled = (i === selectedIndex);
                }
            }
        }

        function closeVideo() {
            const modal = document.getElementById('videoModal');
            const player = document.getElementById('videoPlayer');
            player.pause();
            modal.style.display = 'none';
        }

        function closeSeries() {
            document.getElementById('seriesModal').style.display = 'none';
        }

        function goHome() {
            window.location.href = '/';
        }

        function logout() {
            localStorage.removeItem('authToken');
            localStorage.removeItem('currentUser');
            window.location.href = '/';
        }

        // Close modals when clicking outside
        window.onclick = function(event) {
            const videoModal = document.getElementById('videoModal');
            const seriesModal = document.getElementById('seriesModal');
            
            if (event.target === videoModal) {
                closeVideo();
            }
            if (event.target === seriesModal) {
                closeSeries();
            }
        }
    </script>
</body>
</html>